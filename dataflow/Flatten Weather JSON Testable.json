{
	"name": "Flatten Weather JSON Testable",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "UnzippedJSON",
						"type": "DatasetReference"
					},
					"name": "JSON"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "WeatherArchiving",
						"type": "LinkedServiceReference"
					},
					"name": "ToJSON"
				}
			],
			"transformations": [
				{
					"name": "DrillToLocation"
				},
				{
					"name": "FlattenLocationArray"
				},
				{
					"name": "FlattenLocationFully"
				}
			],
			"script": "parameters{\n\tsource_path as string ('/weatherdata/test/source.json'),\n\ttarget_folder as string ('/weatherdata/test/json')\n}\nsource(output(\n\t\ttime_requested as string,\n\t\tlast_updated as string,\n\t\tSiteRep as (DV as (type as string, dataDate as string, Location as (elevation as string, name as string, i as string, country as string, lon as string, Period as (Rep as (Pp as string, D as string, G as string, F as string, H as string, S as string, U as string, T as string, W as string, V as string, {$} as string), type as string, value as string), lat as string, continent as string)[]), Wx as (Param as (units as string, name as string, {$} as string)[]))\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine',\n\twildcardPaths:[(regexSplit($source_path, `\\/\\w+\\/(.+)`)[1])]) ~> JSON\nJSON derive(Location = SiteRep.DV.Location) ~> DrillToLocation\nDrillToLocation select(mapColumn(\n\t\tLocation\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> FlattenLocationArray\nFlattenLocationArray foldDown(unroll(Location, Location),\n\tmapColumn(\n\t\tElevation = Location.elevation,\n\t\tName = Location.name,\n\t\tCountry = Location.country,\n\t\tLon = Location.lon,\n\t\tLat = Location.lat,\n\t\tContinent = Location.continent,\n\t\tPrecipitationProbability = Location.Period.Rep.Pp,\n\t\tWindDirection = Location.Period.Rep.D,\n\t\tWindGust = Location.Period.Rep.G,\n\t\tFeelsLikeTemperature = Location.Period.Rep.F,\n\t\tScreenRelativeHumidity = Location.Period.Rep.H,\n\t\tWindSpeed = Location.Period.Rep.S,\n\t\tMaxUVIndex = Location.Period.Rep.U,\n\t\tTemperature = Location.Period.Rep.T,\n\t\tWeatherType = Location.Period.Rep.W,\n\t\tVisibility = Location.Period.Rep.V\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> FlattenLocationFully\nFlattenLocationFully sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'json',\n\tfileSystem: (split($target_folder, '/')[2]),\n\tfolderPath: (regexSplit($source_path, `\\/\\w+\\/(.+)`)[1]),\n\tumask: 0022,\n\tpreCommands: [],\n\tpostCommands: [],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1) ~> ToJSON"
		}
	}
}